\documentclass[11pt,a4j]{jsarticle}

\usepackage{float,array,booktabs,here}
\usepackage{amsmath}
\usepackage[dvipdfmx]{graphicx}
\usepackage[top=20truemm,bottom=25truemm,left=20truemm,right=20truemm]{geometry}
\usepackage{url}

\makeatletter
\newcommand{\figcaption}[1]{\def\@captype{figure}\caption{#1}}
\newcommand{\tblcaption}[1]{\def\@captype{table}\caption{#1}}
\makeatother

\newcommand{\Maru}[1]{\ooalign{
\ifnum#1<10 \hfil\resizebox{.9\width}{.85\height}{#1}\hfil
\else
\hfil\resizebox{.6\width}{.8\height}{#1}\hfil
\fi
\crcr
\raise.1ex\hbox{$\bigcirc$}}}

%\usepackage[tableposition=top]{caption}



\begin{document}

% \title{フィルター}
% \author{hogehoge}
% \date{2015年5月9日}
% \maketitle


\section{目的}
デジタル伝送の構成を理解するとともに、デジタル伝送の要素技術とそれらが必要とされる理由を理解する。
具体的には、デジタルオーディオ機器から出力される物理信号を観察し、観察した信号に処理を加えることで、
デジタル音情報がどのように伝送され構成されているのかを理解する。


\section{理論}
\label{sec:理論}

アナログ情報の伝送は情報の波形そのものを転送するが、デジタル情報の伝送は
波形を0と1のデータに変えそれを伝送路符号化して伝送する。
音声自体は元々アナログ情報である。

このとき行われるアナログからデジタルへの変換はA/D変換と呼ばれる。
波形を標本化周波数で示される周期で切り分け、
その部分での値を量子化ビット数で示される段階で状態を記録する。
標本化周波数の半分の周波数はナイキスト周波数と呼ばれ゙、
ナイキスト周波数までは時間軸において損失無くデータが取り出せるという標本化定理がある。

デジタル信号ではアナログ信号と異なり、情報の開始を伝えなけれは、
゙受信側でデジタル情報を読み解くことができない。
そこで伝送の始まりを示す記号としてプリアンブルを付与する。
プリアンブルは複数ビットで構成される符号で、
伝送の始まり以外には検出されないことが保証されている符号である。
したがって、ベースバンドデジタル伝送では、アナログ信号からクロックを抽出し、
アナログ信号の状態、もしくは状態変化から論理値を取り出し,
取り出したビット列からプリアンブルを見つける、
さらにプリアンブルに続くビット列のラインコードを解き、
伝送路符号化されたビット列を取り出す。伝送路符号化されているため、
パリティ等により伝送誤りの検出を行い、取り出した情報の処理を行う。

\subsection{デジタル伝送の規格}
\label{sub:デジタル伝送の規格}

サブフレームは32bitで構成されている。0-3bitの4bitにプリアンブルが入っている。
4-27bitの24bitには音声データが入っており、4bit目が最下位ビットで27bit目が最上位ビットである。
28bit目には音声データが正しいかどうかを示すビット、29bit目はユーザーの自由に使えるビット、
30bit目はチャンネルのステータスを示すビット、 31bit目は偶数パリティビットである。





\subsection{Biphase MarkCode}
\label{sub:Biphase MarkCode}

クロック検出のために単位時間の開始タイミングで状態の変化を発生させ、
単位時間の 1/2 の時点で論理値が1であれば状態を変化させ、論理値が0であれば状態を変化させない。
結果として論理値1と0で周波数が異なる周波数シフトキーイングとなっている。

\section{方法}
\label{sec:方法}

\subsection{実験１}
\label{sub:実験１}

デジタルオーディオのケーブルをデジタルオーディオ機器とスピーカに接続した。
音声が再生されることを確認した。
デジタルオーディオ機器に入力されている信号をオシロスコープに接続し、
物理的に伝送されている波形を確認した。
デジタルオーディオ機器に入力するサンプリングレートが48kHzと96kHzのとき、
A/D,D/A間の伝送ケーブルの信号の線に2m,3m,5m,7mの導線を接続し、
伸ばしたり、くしゃくしゃに丸めたり、コイル状にしたりして
スピーカから再生される音声の状態とオシロスコープで観察される波形を観察した。
サンプリングレートを48kHzにし音声がきちんと再生される状況で、
オシロスコープで観察される電圧の変化から論理値の変化をオシロスコープ上で観察した。
オシロスコープを用いて時間スケールを10ms/divに調整した上で48kHzの
デジタルオーディオ信号をキャプチャし、USBメモリを使ってPCにコピーした。

\subsection{実験２}
\label{sub:実験２}

最初に実験1で作った波形のCSVファイルから0,1の信号の境目となる電圧値を探し0と1のデータに整形した。
そしてデータからプリアンブルというデータの同期に使われる符号を探し、
プリアンブルが出現するごとに整形したデータをBMC符号化のルールに従って復号した。
そして復号したデータから実際の音声データの値を計算した。
次に192ブロックのフレームから求められるCRCチェック符号からCRCのチェックをした。
最後に全体のデータから音声データを作成し音声を確認した。

\subsection{追加実験}
\label{sub:追加実験}

実験２の内容を96kHzのデジタルオーディオ信号をキャプチャしタモので行った。


\section{結果}

\subsection{実験１}
\label{sub:実験１結果}

実験１の結果は以下のようになった。ケーブルを挟んでいない時の基準とした波の形は、
矩形波のような、BMC信号そのもののようなものが観測されていた。これを基準として
ケーブルの状態や、長さを変えた時の波の形を記述した。

\begin{table}[H]
  \caption{サンプリング周波数48kHzの時の実験１の結果}
  \label{tab:j1result48}
  \begin{center}
      \begin{tabular}{cccc}
        \hline
				ケーブルの長さ $\mathrm{m}$	&	ケーブルの状態	&	音の可聴	&	オシロスコープでの波の形状	\\
				\hline  \hline
				0	&	none	&	聞こえた	&	この時の形を基準とする	\\
				2	&	伸ばす	&	聞こえた	&	変化は見られなかった	\\
				2	&	巻く	&	聞こえた	&	少し角が取れた波となった	\\
				3	&	伸ばす	&	聞こえた	&	ほとんど変化はなかった	\\
				3	&	巻く	&	聞こえた	&	角が取れて丸くなった	\\
				5	&	伸ばす	&	聞こえた	&	角が取れて丸くなった	\\
				5	&	巻く	&	聞こえない	&	角が丸くなると共に振幅も小さくなった	\\
				7	&	伸ばす	&	聞こえた	&	角が取れて丸くなった	\\
				7	&	巻く	&	聞こえない	&	角が丸くなると共に振幅も小さくなった	\\ \hline
      \end{tabular}
  \end{center}
\end{table}


\begin{table}[H]
  \caption{サンプリング周波数96kHzの時の実験１の結果}
  \label{tab:j1result48}
  \begin{center}
      \begin{tabular}{cccc}
        \hline
				ケーブルの長さ $\mathrm{m}$	&	ケーブルの状態	&	音の可聴	&	オシロスコープでの波の形状	\\
				\hline  \hline
				0	&	none	&	聞こえた	&	この時の形を基準とする	\\
				2	&	伸ばす	&	聞こえた	&	変化は見られなかった	\\
				2	&	巻く	&	聞こえない	&	少し角が取れた波となった	\\
				3	&	伸ばす	&	聞こえた	&	ほとんど変化はなかった	\\
				3	&	巻く	&	聞こない	&	角が取れて丸くなった	\\
				5	&	伸ばす	&	聞こえた	&	角が取れて丸くなった	\\
				5	&	巻く	&	聞こえない	&	角が丸くなると共に振幅も小さくなった	\\
				7	&	伸ばす	&	聞こえた	&	角が取れて丸くなった	\\
				7	&	巻く	&	聞こえない	&	角が丸くなると共に振幅も小さくなった	\\ \hline
      \end{tabular}
  \end{center}
\end{table}

また48kHzと96kHzを比べると、96kHzの時の方が巻いた部分のケーブルの長さが短くても聞こえなくなった。


\subsection{実験２}
\label{sub:実験２結果}

demodulation.awkは引数で与えられたthr,smplen,startlineの値から、
startline行目から読み込みを開始し、thrを超える電圧値をsmplen回検出すると論理値1を、
-thrを下回る値をsmplen回検出すると論理値0を出すプログラムである。
thrを0.1、smplenを8、startlineを17としてdemodulation.awkを実行した。

preamble.shは引数としてプリアンブルを与えられると、標準入力からプリアンブルを見つけて
整形するプログラムである。プリアンブルは仕様書から11100010,11100100,11101000,
00011101,00011011,00010111を入力し、preamble.shを実行した。

\subsection{追加実験}
\label{sub:追加実験結果}

demodulation.awkの実行時にthrを0.1、smplenを3,4,5、startlineを17として実行したが、
どれについてもプリアンブルを正しく取り出すことができず、
固定長のサブフレームを得ることができなかった。








\section{考察}
\label{sec:考察}


\subsection{誤差の原因と解決策}
\label{sub:誤差の原因と解決策}

ケーブルの長さを長くするほどオシロスコープでの波形は矩形波の形でなく、正弦波のような
山の角の取れた波となっていたことから、誤差は間に長くケーブルを挟んだ際に発生していると
考えられる。ケーブル長が長くなると、電流の減衰が大きくなって復元が難しくなると考えられる。
また、同じコイルの長さでも、コイルを巻いてソレノイド場とした時の方が音が聞こえにくくなったことから、
コイル内の磁束密度が大きくなって、流れている電流を減衰させることで、音がききとりにくくなると
考えられる。
よって、送信する電力を大きくしたり、通信ケーブルを改良して電磁遮蔽したりして物理的な対策
を取ることが求められるであろう。


\subsection{ノイズに対して誤り訂正符号を利用すべきかどうかについて}
\label{sub:ノイズに対して誤り訂正符号を利用すべきかどうかについて}

まず最初に、今回使ったAES/EBUでは各サブフレームに偶数パリティを使い1bitの誤り検出を、
フレーム192個のセットにCRCを用いており8bitの誤り検出が出来るようになっている。
ここでは、検出しか出来ないので誤りがあっても誤りがあることしか分からない。
つまりそのサブフレーム、192個のフレームのセットが壊れていることの検出しかできないのである。

なぜ、誤り検出だけで、訂正は行わないのかということについてであるが、まず最初に考えられるのは、
誤り訂正を行うことによって、転送すべきビット量が増えてしまうということである。

誤り訂正を行わない場合では、
\begin{align*}
	48 \mathrm{kHz} \times 32 \mathrm{bit} \times 2 \mathrm{ch} = 3.072 \mathrm{Mbps}
\end{align*}

で、BMCでは

\begin{align*}
	3.072 \mathrm{Mbps} \times 2 = 6.144 \mathrm{Msymbol/s}
\end{align*}

であるが、これに対して訂正符号を入れたとしても伝送すべき量は、数倍の範囲で収まるので、$10 \mathrm{Mbps}$
のオーダーである。現在のオーディオケーブルでは、この程度の容量は簡単に収めることができるので、
容量が増えるから訂正符号を用いないというのは、訂正符号を用いないことの理由とは思えない。

伝送路の誤りについてであるが、誤り方としては、バースト誤りという誤り方が起きていると思われる。
このバースト誤りというのは、一つの値だけが謝るのではなく、周りの値も巻き込んでいろいろな
値が一緒に影響を受ける。よってこのバースト誤りに対して、強い訂正符号を用意しようと思うと
バースト誤りの影響を受けないところに冗長ビットを置かなければならない。例えば、
\begin{align*}
	11001010
\end{align*}
を送るときに、
\begin{align*}
	111 111 000 000 111 000 111 000
\end{align*}
というふうに送ってしまうと、3bit以上の長さでバースト誤りが起きた際に、誤り訂正を行うことができない。そこで、
\begin{align*}
	11001010 11001010 11001010
\end{align*}
と送ったとする。そうすることで、バースト誤りに対しての対応力は強くなると考えられる。
上のバースト誤りに弱い方法では、すぐに訂正を行うことができるため、遅延は少なくて済むのであるが、
下のバースト誤りに対して強いと思われる、訂正符号の入れ方をすると、訂正できるまでに構造的に時間がかかり、
遅延が起きてしまう。プロの音楽家が使用する、AES/EBUのこの規格に対しては遅延するというのは
大きなマイナス点であるため、訂正符号でなく、誤り検出のみを行うと考えられる。
誤り検出が存在する理由としては、機材設置の際に、誤りが検出できることによって、未然に誤りの起きにくい
設置方法などを模索していけるためであると考えられる。


\subsection{引数thrとsamplenにどのような値を用いると正しく整形された結果が得られるか}
\label{sub:引数thrとsamplen}

AES/EBUのアイパターンの図を見てみると、$\mathrm{V_{min}} = 200 \mathrm{mV}$と書かれている。
thrはこの半分の値であるため、$\mathrm{thr} = 0.1 \mathrm{V}$である。

次にsamplenの値について。

上でも述べたが、周波数$48 \mathrm{kHz}$、サブフレーム$32\mathrm{bit}$、チャンネル数２の伝送速度は
\begin{align*}
  48 \mathrm{kHz} \times 32 \mathrm{bit} \times 2 \mathrm{ch} = 3.072 \mathrm{Mbps}
\end{align*}
そして、Biphase Mark Codeでは

\begin{align*}
	3.072 \mathrm{Mbps} \times 2 = 6.144 \mathrm{Msymbol/s}
\end{align*}
となる。
よって1symbolを送るのにかかる時間は
\begin{align*}
  \frac{1}{6.144\mathrm{Msymbol/s}} = 162.8 \mathrm{ns_symbol}
\end{align*}
ともとエメルことができる。
AES/SBUの規格書よりサンプリングにかかる最初の時間は、
\begin{align*}
  \mathrm{T_{min}} = 40.69 \mathrm{ns}
\end{align*}
である。
そしてオシロスコープでのサンプリングレートは出力されたcsvファイルを見てみると
samplerate = 62500000となっているので、
読み取る間隔は、
\begin{align*}
  \frac{1}{62500000} = 16\mathrm{ns}
\end{align*}
である。つまり、最小時間40.69nsのサンプリングを撮るには、
\begin{align*}
  \frac{40.69\mathrm{ns}}{16\mathrm{ns}} = 2.543個
\end{align*}
のサンプル数を取れば良いと考えられる。つまりsamplenの最適値は３である。

しかしながら、csvファイルを見てみると、1symbolあたりに電圧値は９個ほど存在する。
もし仮にsamplen=3としてしまうと、1symbolが3symbol分として、値が取れてしまう。
これは用いたプログラムの質が悪いからであり、BMCの特徴を生かせていないからである。


\subsection{96kHzのデータとの比較}
\label{sub:96kHzのデータとの比較}

96kHzのデータでは、結果からみてもわかるようにノイズが乗りやすくなっていた。なぜノイズが乗りやすくなっていたのかというと、
標本化周波数が高いために、伝送周波数も高くなる、つまり0と1の入れ替わりが激しくなって、波形の乱れに
弱くなっているからだと考えられる。データ部分に2bit以上の誤りが生じた場合には、パリティビットでは
誤りを検出できないので、大きく誤ってしまった場合には検出ができないものと考えられる。

\subsection{CRC8\_POLYNOMIALの決定方法について}
\label{sub:CRC8}


今回は、CRC8\_POLYNOMIALには100011101を用いた。
これが選ばれた理由は、100011101の生成多項式G(X)は原子多項式であり、
この数で割った時の周期も同じ255になるのでCRCの符号チェックにおいて
かぶる符号が少ないのでチェックにおいて非常に有効なのでこの値が選ばれていると考えられる。

\subsection{BMCを生かしたプログラムについて}
\label{sub:BMCを生かしたプログラムについて}

BMC゙は「クロックの真ん中で状態変化するか/しないか」で1と0を判別している。
つまり、状態変化の有無を読み取ることができれば良いのである。
状態が変化する瞬間は傾きの絶対値が最大である。これをプログラムで検知すればよい。
つまり、オシロスコープの各サンプル値の差分を求め、その値の絶対値が一定値以上であるものを探し、
その前後で状態が変化していることを確認すればよい。

次に、このプログラムのクロック共有方法について考える。
BMCは2シンボルで1クロック分である。そこで1シンボルの周期を検出し、
その2倍を1クロックとして扱えばよい。1シンボルの周期はプリアンブル伝送時に必ず取得できる。
クロックは時間がたつとずれていく可能性があるので常に修正する必要があると考えられる。







\begin{thebibliography}{99} %ケタ数(９：一桁、９９：二桁)
  \bibitem{keio} デジタル伝送の基礎, 金子晋丈, 2013.
  \bibitem{kiso} デジタル通信の基礎, 岡育生, 森北出版株式会社 ,　2009.
\end{thebibliography}

\end{document}
